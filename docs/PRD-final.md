# 产品管理众筹系统 PRD 文档（最终确认版）

> 版本：v1.0
> 更新日期：2024年
> 说明：本文档为开发团队与产品方最终确认的需求规格说明

---

## 一、系统概述

### 1.1 系统定位
本系统为公司内部使用的产品管理众筹平台，用于管理产品开发、内部众筹、供应商竞价、资金使用等业务流程。

### 1.2 技术栈
| 层面 | 技术选型 |
|------|---------|
| 数据库 | MySQL 8.0 |
| 后端框架 | NestJS (Node.js) |
| 开发语言 | TypeScript |
| ORM | Prisma |
| 认证方式 | JWT |
| API风格 | RESTful |
| API文档 | Swagger |

### 1.3 开发范围（第一期）
- ✅ 用户管理模块
- ✅ 产品管理模块
- ✅ 众筹管理模块
- ✅ 资金管理模块
- ✅ 操作日志模块
- ❌ 打样评分模块（后期迭代）

---

## 二、用户角色体系

### 2.1 角色定义

| 角色 | 英文标识 | 权限级别 | 主要职责 |
|------|---------|---------|---------|
| 超级管理员 | super_admin | 最高级 | 系统全局管理，用户创建和权限分配 |
| 普通管理员 | admin | 高级 | 部门管理，销售团队管理 |
| 产品开发 | product_dev | 中级 | 产品创建和管理，发起众筹，参与众筹 |
| 销售 | sales | 中级 | 产品创建，发起众筹，参与众筹 |
| 供应商 | supplier | 中级 | 发起众筹，参与众筹（竞价），提供供应服务 |
| 供应商子账号 | supplier_sub | 中级 | 参与众筹（竞价），提供供应服务 |
| 加工厂 | factory | 外部 | 产品加工（不参与众筹） |
| 加工厂子账号 | factory_sub | 外部子级 | 隶属于加工厂的操作账号 |

### 2.2 隶属关系

```
超级管理员 (super_admin)
    ├── 普通管理员 (admin)
    │       └── 销售 (sales)
    ├── 产品开发 (product_dev)
    └── 供应商 (supplier)
            ├── 供应商子账号 (supplier_sub)
            └── 加工厂 (factory)
                    └── 加工厂子账号 (factory_sub)
```

### 2.3 模块权限体系

系统采用 **角色 + 模块** 的双重权限控制机制。

**可分配模块：**
- 产品管理 (`product`)
- 众筹管理 (`crowdfunding`)
- 资金管理 (`fund`)

**权限分配规则：**

| 角色 | 产品管理 | 众筹管理 | 资金管理 | 用户管理 |
|------|---------|---------|---------|---------|
| 超级管理员 | ✅ | ✅ | ✅ | ✅（独占） |
| 普通管理员 | 可分配 | 可分配 | 可分配 | ❌ |
| 产品开发 | 可分配 | 可分配 | 可分配 | ❌ |
| 销售 | 可分配 | 可分配 | 可分配 | ❌ |
| 供应商 | 可分配 | 可分配 | 可分配 | ❌ |
| 供应商子账号 | 可分配 | 可分配 | 可分配 | ❌ |
| 加工厂 | 可分配 | ❌ 不可分配 | 可分配 | ❌ |
| 加工厂子账号 | 可分配 | ❌ 不可分配 | 可分配 | ❌ |

---

## 三、用户认证

### 3.1 登录方式
- 账号 + 密码登录
- 使用 JWT Token 进行身份验证

### 3.2 账号创建
- 仅需设置：用户名、密码
- 由超级管理员创建所有账号
- 用户名全局唯一

### 3.3 密码规则
- 密码加密存储（bcrypt）
- 支持密码重置功能

---

## 四、用户管理模块

### 4.1 访问权限
- 仅超级管理员可访问

### 4.2 功能清单

| 功能 | 说明 |
|------|------|
| 创建账号 | 选择角色类型 → 填写用户名/密码 → 设置隶属关系 → 勾选模块权限 |
| 账号列表 | 分角色展示，支持搜索筛选 |
| 编辑账号 | 修改基本信息、模块权限 |
| 禁用/启用 | 控制账号状态 |
| 密码重置 | 重置用户密码 |
| 删除账号 | 删除用户（需处理关联数据） |

### 4.3 创建账号时的隶属关系

| 角色 | 必须选择的上级 |
|------|---------------|
| 销售 | 所属普通管理员 |
| 供应商子账号 | 所属供应商 |
| 加工厂 | 所属供应商 |
| 加工厂子账号 | 所属加工厂 |

---

## 五、产品管理模块

### 5.1 产品创建权限
- 产品开发、销售、供应商、供应商子账号可创建产品

### 5.2 产品字段

| 列 | 字段 |
|---|------|
| 第一列 | 产品图片 |
| 第二列 | 创建日期、产品名称、产品货号、选品/开发人 |
| 第三列 | 产品状态、产品SKU、产品链接、对接工厂 |
| 第四列 | 出厂价、价格管控、产品重量（克）、包装尺寸 |
| 第五列 | 产品实拍照片、专利状态、众筹状态 |

### 5.3 产品编辑权限
- **创建人**可编辑
- **整条管理链上级**都可编辑

示例：
- 销售A 创建的产品 → 销售A、普通管理员（A的上级）、超级管理员 均可编辑
- 供应商子账号D 创建的产品 → D、供应商（D的上级）、超级管理员 均可编辑

### 5.4 众筹状态（产品维度）

| 状态 | 说明 |
|------|------|
| not_started | 未发起众筹，可以发起 |
| in_progress | 众筹进行中，不可重复发起 |
| success | 众筹成功 |
| failed | 众筹失败，可重新发起 |
| cancelled | 众筹已取消，可重新发起 |

### 5.5 图片上传限制
- 格式：jpg、jpeg、png、gif、webp
- 大小：单张最大 5MB

---

## 六、众筹管理模块

### 6.1 众筹发起权限

| 角色 | 能否发起众筹 |
|------|-------------|
| 超级管理员 | ✅ |
| 普通管理员 | ✅ |
| 产品开发 | ✅（仅自己创建的产品） |
| 销售 | ✅ |
| 供应商 | ✅ |
| 供应商子账号 | ❌ |
| 加工厂 | ❌ |
| 加工厂子账号 | ❌ |

### 6.2 众筹参与（出资）权限

| 角色 | 能否出资 | 竞价模式 |
|------|---------|---------|
| 超级管理员 | ✅ | 普通出资 |
| 普通管理员 | ✅ | 普通出资 |
| 产品开发 | ✅ | 普通出资 |
| 销售 | ✅ | 普通出资 |
| 供应商 | ✅ | 竞价出资 |
| 供应商子账号 | ✅ | 竞价出资 |
| 加工厂 | ❌ | - |
| 加工厂子账号 | ❌ | - |

### 6.3 发起众筹参数

| 参数 | 说明 |
|------|------|
| 众筹目标金额 | 必填，发起后不可修改 |
| 众筹截止时间 | 参考时间，系统按周自动滚动期数 |
| 最小出资金额 | 默认 100 元 |
| 众筹说明 | 选填 |

### 6.4 出资规则

| 规则 | 说明 |
|------|------|
| 首次出资最低金额 | 100 元 |
| 追加出资最低金额 | 100 元 |
| 出资后按钮变化 | "出资" → "追加" |

### 6.5 供应商竞价规则

1. **竞价主体**：供应商及其子账号的出资**合并计算**为供应商组的总出资额
2. **排名依据**：按供应商组的总出资额排名
3. **金额约束**：**不允许**两个供应商组的出资总额相同（系统校验）
4. **中标规则**：众筹成功时，系统**自动**将最高出资的供应商标记为中标

### 6.6 期数机制

- **一期 = 一周**（周一至周日）
- 众筹未在一期内达成目标 → **自动滚入下一期**继续
- 众筹可跨多期，直到：成功 / 被取消 / 手动标记失败

### 6.7 众筹状态流转

```
发起众筹 → 进行中 (in_progress)
              ↓
    ┌─────────┼─────────┐
    ↓         ↓         ↓
  成功     取消       失败
(success) (cancelled) (failed)
```

### 6.8 状态变更条件

| 目标状态 | 触发条件 |
|---------|---------|
| 成功 (success) | 当前金额 ≥ 目标金额（自动） |
| 取消 (cancelled) | 发起人或管理员手动取消 |
| 失败 (failed) | 发起人或管理员手动标记失败 |

### 6.9 取消/失败后处理
- 资金**归还**所有出资人
- 产品众筹状态更新，**可重新发起**众筹

### 6.10 众筹取消权限
- 众筹发起人
- 普通管理员
- 超级管理员

---

## 七、资金管理模块

### 7.1 期数定义
- **一期 = 一周**
- 系统自动按周生成期数记录

### 7.2 资金总览仪表板

| 统计项 | 说明 |
|--------|------|
| 当期总额 | 当前期数的总众筹金额 |
| 当期已使用总额 | 已经使用的资金金额 |
| 当期余额 | 剩余可用资金 |
| 当期平均使用率 | 资金使用效率 |
| 期数筛选 | 下拉选择不同期数查看对应数据 |

### 7.3 资金使用记录字段

| 字段 | 说明 |
|------|------|
| 期数 | 资金所属期数 |
| 筹措时间 | 众筹完成时间范围 |
| 姓名 | 资金使用者姓名 |
| 部门 | 使用者所属部门 |
| 基础额度 | 该用户可使用的基础金额 |
| 已使用金额 | 实际已使用的资金 |
| 未使用金额 | 剩余可用资金 |
| 完成金额 | 项目完成所需总金额 |
| 使用率 | 已使用金额/基础额度的百分比 |
| 状态 | 进行中/已完成/已暂停 |

### 7.4 资金使用审批链

```
供应商子账号 → 供应商 → 普通管理员 → 超级管理员
加工厂子账号 → 加工厂 → 供应商 → 普通管理员 → 超级管理员
销售 → 普通管理员 → 超级管理员
产品开发 → 普通管理员 → 超级管理员
```

### 7.5 审批权限
- 申请权限：有众筹参与记录的用户可申请使用对应资金
- 审批权限：按审批链逐级审批

### 7.6 资金性质
- **虚拟数字**，无真实支付/退款流程
- 内部员工使用的记账系统

---

## 八、操作日志模块

### 8.1 记录内容

| 字段 | 说明 |
|------|------|
| 操作人 | 执行操作的用户 |
| 操作时间 | 操作发生时间 |
| 模块 | 所属功能模块 |
| 操作类型 | 创建/编辑/删除/审批等 |
| 目标对象 | 操作的具体对象 |
| 操作前数据 | JSON格式记录变更前状态 |
| 操作后数据 | JSON格式记录变更后状态 |
| IP地址 | 操作者IP |
| 浏览器信息 | User-Agent |

### 8.2 记录场景
- 用户创建/编辑/删除/状态变更
- 产品创建/编辑/删除
- 众筹发起/出资/取消/状态变更
- 资金申请/审批

---

## 九、业务流程图

### 9.1 用户创建流程
```
超级管理员登录 → 进入用户管理 → 选择角色类型 → 填写用户名/密码
→ 设置隶属关系（如需要） → 勾选模块权限 → 确认创建 → 账号生成
```

### 9.2 产品众筹流程
```
产品创建 → 完善产品信息 → 点击发起众筹 → 设置众筹参数（目标金额等）
→ 众筹开始（进行中） → 各角色参与出资 → 达到目标金额 → 众筹成功
→ 自动确定中标供应商（最高出资）
```

### 9.3 供应商竞价流程
```
供应商查看众筹项目 → 查看当前最高出资排名 → 填写出资金额
→ 系统校验金额不重复 → 出资成功 → 更新排名 → 其他供应商继续竞价
→ 众筹成功 → 最高出资供应商中标
```

### 9.4 资金使用审批流程
```
用户提交资金使用申请 → 系统确定审批人（按审批链）
→ 审批人审批（通过/拒绝） → 通过则流转到下一级审批人
→ 最终审批通过 → 资金使用记录生效
```

---

## 十、功能优先级

### P0（核心功能 - 第一期必须实现）
- [x] 用户角色创建和模块权限管理
- [x] 产品创建和管理
- [x] 基础众筹出资功能
- [x] 供应商竞价逻辑
- [x] 资金管理基础功能（总览、记录查看）
- [x] 操作日志

### P1（重要功能 - 第一期实现）
- [x] 追加出资功能
- [x] 众筹状态管理（取消、失败）
- [x] 资金使用审批流程
- [x] 期数自动滚动

### P2（后期迭代）
- [ ] 打样评分模块
- [ ] 数据统计分析图表
- [ ] 报表导出功能

---

## 十一、附录

### 11.1 状态枚举值

**用户状态：**
- `1` - 启用
- `0` - 禁用

**众筹状态：**
- `in_progress` - 进行中
- `success` - 成功
- `failed` - 失败
- `cancelled` - 已取消

**产品众筹状态：**
- `not_started` - 未发起众筹
- `in_progress` - 众筹进行中
- `success` - 众筹成功
- `failed` - 众筹失败
- `cancelled` - 众筹已取消

**资金申请状态：**
- `pending` - 待审批
- `approved` - 已通过
- `rejected` - 已拒绝
- `cancelled` - 已撤销

**出资类型：**
- `initial` - 首次出资
- `additional` - 追加出资

### 11.2 角色英文标识
- `super_admin` - 超级管理员
- `admin` - 普通管理员
- `product_dev` - 产品开发
- `sales` - 销售
- `supplier` - 供应商
- `supplier_sub` - 供应商子账号
- `factory` - 加工厂
- `factory_sub` - 加工厂子账号

---

*文档结束*
